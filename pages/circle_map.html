<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Circle Map — Arnold Tongues</title>
  <style>
    :root { --bg:#f5f5f5; --accent:#0366d6; --muted:#666; }
    body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 2rem; background: var(--bg); }
    h1 { text-align: center; color: #333; margin-bottom: .25rem; }
    p { color: #444; line-height: 1.6; }
    .layout { display: grid; grid-template-areas: 'top' 'main' 'bottom'; gap: 16px; }
    .main { grid-area: main; }
    .note-bubble { background: #fff8dc; border: 1px solid #f0e6b6; border-radius: 8px; padding: 10px; color: #5b4b20; }
    .note-top { grid-area: top; } .note-bottom { grid-area: bottom; } .note-left { grid-area: left; } .note-right { grid-area: right; }
    @media(min-width: 1100px){ .layout { grid-template-columns: 260px 1fr 260px; grid-template-areas: 'top top top' 'left main right' 'bottom bottom bottom'; } }
    .panel { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.04); }
    .controls { display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:10px; }
    label { font-size:.9rem; color:var(--muted); }
    input[type="number"]{ width:90px; }
    input[type="range"]{ width:220px; }
    .button{ background:var(--accent); border:none; color:#fff; padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer; }
    .button.secondary{ background:#6b7280; }
    canvas { width: 100%; height: auto; background: #fff; border:1px solid #ddd; border-radius:6px; }
    .back { display:inline-block; margin-top:18px; color:var(--accent); text-decoration:none; font-weight:bold; }
</style>
    <link rel="stylesheet" href="../assets/css/theme.css" />
</head>
<body>
  <h1>Circle Map — Arnold Tongues</h1>
  <p>Explore the circle map θₙ₊₁ = θₙ + Ω − (K/2π) sin(2πθₙ) mod 1. Visualize orbits and mode‑locking regions (Arnold tongues) in (Ω, K).</p>

  <div class="layout">
    <div class="note-bubble note-top">Top notes — mode locking, devil’s staircase, rotation number.</div>
    <div class="note-bubble note-left">Side notes — tongues widen with K.</div>

    <div class="main">
      <div class="panel">
        <h3 style="margin:6px 0 8px 0">Orbits on the Circle</h3>
        <div class="controls">
          <label>Ω: <input id="omega" type="number" step="0.001" value="0.33"/></label>
          <label>K: <input id="K" type="number" step="0.01" value="0.6"/></label>
          <label>Iter: <input id="N" type="number" step="10" value="600"/></label>
          <label>Speed: <input id="oSpeed" type="range" min="1" max="30" step="1" value="12"/></label>
          <button class="button" id="orbitPlay">Play</button>
          <button class="button secondary" id="orbitReset">Reset</button>
          <button class="button secondary" id="orbitClear">Clear</button>
        </div>
        <canvas id="orbit" width="1000" height="360"></canvas>
        <div style="font-size:.9rem;color:#666;margin-top:6px;">Left: circle with points; Right: θ vs n (unwrapped).</div>
      </div>

      <div class="panel" style="margin-top:16px;">
        <h3 style="margin:6px 0 8px 0">Arnold Tongues (Ω vs K)</h3>
        <div class="controls">
          <label>Ω min: <input id="oMin" type="number" step="0.01" value="0"/></label>
          <label>Ω max: <input id="oMax" type="number" step="0.01" value="1"/></label>
          <label>K max: <input id="kMax" type="number" step="0.05" value="1.5"/></label>
          <label>Grid: <input id="grid" type="number" step="10" value="300"/></label>
          <label>Iter: <input id="tIter" type="number" step="50" value="500"/></label>
          <button class="button" id="tongues">Render</button>
        </div>
        <canvas id="tongue" width="1000" height="640"></canvas>
      </div>
      <p><a class="back" href="../index.html">← Back to Introduction</a></p>
    </div>

    <div class="note-bubble note-right">Side notes — rational p/q regions lock.</div>
    <div class="note-bubble note-bottom">Bottom notes — add references or derivation.</div>
  </div>

  <script>
  function circleStep(theta, omega, K){
    const v = theta + omega - (K/(2*Math.PI))*Math.sin(2*Math.PI*theta);
    return ((v % 1) + 1) % 1; // keep in [0,1)
  }
  (function(){
    const canvas=document.getElementById('orbit'); const ctx=canvas.getContext('2d');
    const cx=200, cy=180, R=120; const plotX0=360, plotY0=20, plotW=canvas.width-380, plotH=canvas.height-40;
    let playing=false, version=0; let th=0.1, unwrapped=0.1, n=0;
    function clearOrbit(){ ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='#999'; ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.stroke(); ctx.strokeStyle='#eee'; ctx.strokeRect(plotX0,plotY0,plotW,plotH); }
    function startOrbit(){ const my=++version; playing=true; n=0; th=0.1; unwrapped=0.1; clearOrbit(); step(); function step(){ if(my!==version) return; if(!playing){ requestAnimationFrame(step); return; } const omega=parseFloat(document.getElementById('omega').value); const K=parseFloat(document.getElementById('K').value); const N=parseInt(document.getElementById('N').value,10); const speed=parseInt(document.getElementById('oSpeed').value,10); ctx.strokeStyle='#0366d6'; ctx.lineWidth=1.2; ctx.beginPath(); for(let s=0;s<speed && n<N; s++, n++){ const x=cx+R*Math.cos(2*Math.PI*th), y=cy+R*Math.sin(2*Math.PI*th); ctx.fillStyle='rgba(3,102,214,0.9)'; ctx.beginPath(); ctx.arc(x,y,2.0,0,Math.PI*2); ctx.fill(); const px=plotX0 + (n/(N-1))*plotW; const py=plotY0 + (1-((unwrapped%1)))*plotH; if(n===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); const next=circleStep(th,omega,K); let d=next-th; if(d>0.5) d-=1; if(d<-0.5) d+=1; unwrapped+=d; th=next; } ctx.stroke(); if(n<N){ requestAnimationFrame(step); } }
    }
    document.getElementById('orbitPlay').addEventListener('click', (e)=>{ if(!playing){ e.target.textContent='Pause'; if(n===0 || n>=parseInt(document.getElementById('N').value,10)) startOrbit(); else { playing=true; } } else { playing=false; e.target.textContent='Play'; } });
    document.getElementById('orbitReset').addEventListener('click', ()=>{ playing=false; document.getElementById('orbitPlay').textContent='Play'; th=0.1; unwrapped=0.1; n=0; clearOrbit(); });
    document.getElementById('orbitClear').addEventListener('click', ()=>{ clearOrbit(); });
    clearOrbit();
  })();
  function renderTongues(){
    const canvas=document.getElementById('tongue'); const ctx=canvas.getContext('2d');
    const oMin=parseFloat(document.getElementById('oMin').value), oMax=parseFloat(document.getElementById('oMax').value), kMax=parseFloat(document.getElementById('kMax').value); const grid=parseInt(document.getElementById('grid').value,10); const tIter=parseInt(document.getElementById('tIter').value,10);
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const toX=omega=> ( (omega-oMin)/(oMax-oMin) )*(canvas.width-60)+40; const toY=K=> (1-K/kMax)*(canvas.height-60)+20;
    // axes
    ctx.strokeStyle='#999'; ctx.strokeRect(40,20,canvas.width-60,canvas.height-60);
    let j=0; const rows=Math.max(60, Math.floor(grid*0.6)); const cols=grid; const chunk=Math.max(1, Math.floor(rows/120));
    function frame(){
      for(let r=0;r<chunk;r++){
        if(j>=rows){ requestAnimationFrame(frame); return; }
        const K = (j/(rows-1))*kMax; for(let i=0;i<cols;i++){
          const omega = oMin + (i/(cols-1))*(oMax-oMin);
          let th=0.1; // warm-up
          for(let t=0;t<200;t++) th=circleStep(th,omega,K);
          let w=0; let u=th; for(let t=0;t<tIter;t++){ const next=circleStep(u,omega,K); let d=next-u; if(d>0.5) d-=1; if(d<-0.5) d+=1; w+=d; u=next; }
          const rot = w/tIter; // rotation number
          // color by closeness to rationals with small q
          const qMax=6; let bestQ=0; let bestErr=1e9; for(let q=1;q<=qMax;q++){ const p=Math.round(rot*q); const err=Math.abs(rot - p/q); if(err<bestErr){ bestErr=err; bestQ=q; } }
          const hue= 220 - 160*(bestQ-1)/(qMax-1); const alpha = Math.max(0.15, Math.min(0.9, 0.6 - Math.log10(1e-6+bestErr)));
          ctx.fillStyle=`hsla(${hue},90%,45%,${alpha})`;
          const px=toX(omega), py=toY(K); ctx.fillRect(px,py,1,1);
        }
        j++;
      }
      if(j<rows) requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }
  document.getElementById('orbitDraw').addEventListener('click', drawOrbit);
  document.getElementById('orbitClear').addEventListener('click', ()=>{ const c=document.getElementById('orbit'); c.getContext('2d').clearRect(0,0,c.width,c.height); });
  document.getElementById('tongues').addEventListener('click', renderTongues);
  // initial quick draws
  drawOrbit();
  setTimeout(renderTongues, 50);
  </script>
</body>
</html>
