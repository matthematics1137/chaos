<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lorenz Attractor — Strange Attractor</title>
    <style>
        :root { --bg:#f5f5f5; --accent:#0366d6; --muted:#666; }
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 2rem; background: var(--bg); }
        h1 { text-align: center; color: #333; margin-bottom: .25rem; }
        p { color: #444; line-height: 1.6; }
        .layout { display: grid; grid-template-areas: 'top' 'main' 'bottom'; gap: 16px; }
        .main { grid-area: main; }
        .note-bubble { background: #fff8dc; border: 1px solid #f0e6b6; border-radius: 8px; padding: 10px; color: #5b4b20; }
        .note-top { grid-area: top; }
        .note-bottom { grid-area: bottom; }
        .note-left { grid-area: left; }
        .note-right { grid-area: right; }
        @media(min-width: 1100px){
            .layout { grid-template-columns: 260px 1fr 260px; grid-template-areas: 'top top top' 'left main right' 'bottom bottom bottom'; }
        }
        .panel { background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; }
        .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 10px; }
        label { font-size: .9rem; color: var(--muted); }
        input[type="number"] { width: 90px; }
        input[type="range"] { width: 220px; }
        .button { background: var(--accent); border: none; color: white; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .button.secondary { background: #6b7280; }
        canvas { width: 100%; height: auto; background: linear-gradient(180deg,#ffffff,#f7fbff); border: 1px solid #ddd; border-radius: 6px; }
        .back { display: inline-block; margin-top: 18px; color: var(--accent); text-decoration: none; font-weight: bold; }
</style>
    <link rel="stylesheet" href="../assets/css/theme.css" />
</head>
<body>
    <h1>Lorenz Attractor</h1>
    <p>
        The Lorenz system is a minimal model for atmospheric convection that
        produces a famous strange attractor. Small differences in initial
        conditions lead to dramatically different trajectories — the hallmark of
        chaos.
    </p>

    <div class="layout">
        <div class="note-bubble note-top">Top notes area — author explanations.</div>
        <div class="note-bubble note-left">Side notes — parameter meanings or behavior cues.</div>

        <div class="main">
        <div class="panel">
            <div class="controls">
                <label>σ: <input id="sigma" type="number" step="0.1" value="10"/></label>
                <label>ρ: <input id="rho" type="number" step="0.1" value="28"/></label>
                <label>β: <input id="beta" type="number" step="0.01" value="2.6667"/></label>
                <label>dt: <input id="dt" type="number" step="0.0005" value="0.005"/></label>
                <label>Speed: <input id="speed" type="range" min="1" max="20" step="1" value="5"/></label>
                <button class="button" id="toggle">Pause</button>
                <button class="button secondary" id="reset">Reset</button>
                <button class="button secondary" id="clear">Clear</button>
            </div>
        <canvas id="lorenz" width="1000" height="700"></canvas>
        </div>
        </div>

        <div class="note-bubble note-right">Side notes — annotate lobes, sensitivity, return maps.</div>
        <div class="note-bubble note-bottom">Bottom notes — add summary or references.</div>
    </div>

    <a class="back" href="../index.html">← Back to Introduction</a>

    <script>
    function rk4Lorenz(state, params, dt){
        const f = (s)=>{
            const [x,y,z] = s; const {sigma, rho, beta} = params;
            return [ sigma*(y-x), x*(rho - z) - y, x*y - beta*z ];
        };
        const add = (a,b,scale=1)=> a.map((v,i)=> v + scale*b[i]);
        const mul = (a,scale)=> a.map(v=> v*scale);
        const k1 = f(state);
        const k2 = f(add(state, mul(k1, dt/2)));
        const k3 = f(add(state, mul(k2, dt/2)));
        const k4 = f(add(state, mul(k3, dt)));
        const incr = [0,1,2].map(i => (k1[i] + 2*k2[i] + 2*k3[i] + k4[i]) * dt/6);
        return add(state, incr);
    }

    function makeProjector(width, height){
        let angle = 0;
        const centerX = width/2, centerY = height/2;
        const scale = 10; // visual scale
        return {
            step(){ angle += 0.003; },
            project([x,y,z]){
                // rotate around Z then X for a simple 3D effect
                const cosA = Math.cos(angle), sinA = Math.sin(angle);
                let xr = x*cosA - y*sinA;
                let yr = x*sinA + y*cosA;
                let zr = z;
                const cosB = Math.cos(angle*0.7), sinB = Math.sin(angle*0.7);
                let yr2 = yr*cosB - zr*sinB;
                let zr2 = yr*sinB + zr*cosB;
                const px = centerX + xr*scale;
                const py = centerY - (yr2)*scale;
                const alpha = Math.max(0.1, Math.min(1, 0.2 + (zr2+30)/60));
                return {x:px, y:py, a:alpha};
            }
        };
    }

    (function(){
        const canvas = document.getElementById('lorenz');
        const ctx = canvas.getContext('2d');
        let running = true;
        let state = [0.01, 0, 0];
        let params = { sigma: 10, rho: 28, beta: 8/3 };
        let proj = makeProjector(canvas.width, canvas.height);

        function readParams(){
            params.sigma = parseFloat(document.getElementById('sigma').value);
            params.rho = parseFloat(document.getElementById('rho').value);
            params.beta = parseFloat(document.getElementById('beta').value);
            dt = parseFloat(document.getElementById('dt').value);
            speed = parseInt(document.getElementById('speed').value,10);
        }

        let dt = 0.005;
        let speed = 5; // substeps per frame

        function step(){
            readParams();
            if(running){
                for(let i=0;i<speed;i++){
                    const next = rk4Lorenz(state, params, dt);
                    const p1 = proj.project(state);
                    const p2 = proj.project(next);
                    // Color by z-depth and add slight glow
                    const hue = 210 + Math.max(-40, Math.min(40, (next[2]-state[2])))*2;
                    ctx.strokeStyle = `hsla(${hue}, 80%, 45%, ${p2.a})`;
                    ctx.lineWidth = 1.2;
                    ctx.beginPath(); ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
                    state = next;
                    proj.step();
                }
            }
            requestAnimationFrame(step);
        }

        // Controls
        document.getElementById('toggle').addEventListener('click', (e)=>{
            running = !running;
            e.target.textContent = running ? 'Pause' : 'Resume';
        });
        document.getElementById('reset').addEventListener('click', ()=>{
            // Restore defaults and clear canvas
            document.getElementById('sigma').value = 10;
            document.getElementById('rho').value = 28;
            document.getElementById('beta').value = 2.6667;
            document.getElementById('dt').value = 0.005;
            document.getElementById('speed').value = 5;
            state = [0.01, 0, 0];
            ctx.clearRect(0,0,canvas.width, canvas.height);
            // Recreate projector to reset rotation
            proj = makeProjector(canvas.width, canvas.height);
            // Ensure running
            running = true; document.getElementById('toggle').textContent = 'Pause';
        });
        document.getElementById('clear').addEventListener('click', ()=>{
            ctx.clearRect(0,0,canvas.width, canvas.height);
        });

        // kick off
        step();
    })();
    </script>

    <!-- Equations:
         dx/dt = sigma (y - x)
         dy/dt = x (rho - z) - y
         dz/dt = x y - beta z -->
</body>
</html>
